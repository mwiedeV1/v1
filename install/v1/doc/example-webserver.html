
	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />	
		<title>V1 Script - HTTP/SSL Server</title>
		<link rel="stylesheet" type="text/css" href="css/style.css" />
	</head>
	
	<body>
	
	<div class="logo"><a href="index.html"><img src="images/v1_logo.png" alt="V1 Script"/></a></div>
	
	<div class="page_wrap">
	<h1>Example: HTTP Webserver</h1>
<p>Demonstrates various functions and techniques of <a href="system-functions.html">system functions</a>, <a href="file-functions.html">file functions</a>, <a href="socket-functions.html">socket functions</a>, <a href="thread-functions.html">thread functions</a> and <a href="module-ssl.html">ssl module</a>.</p>
<pre><code><span style="color: #000000"></span><span style="color: #0000BB;">&lt;?</span><span style="color: #000000">v1<br /></span><span style="color: #008000">/*&nbsp;<br />&nbsp;&nbsp;Simple&nbsp;HTTP-Server<br />&nbsp;&nbsp;This&nbsp;V1&nbsp;program&nbsp;will&nbsp;create&nbsp;a&nbsp;multithreaded&nbsp;HTTP-Server&nbsp;on&nbsp;localhost:8080&nbsp;(optional&nbsp;with&nbsp;TLS/SSL)<br />&nbsp;&nbsp;with&nbsp;document&nbsp;path&nbsp;of&nbsp;current&nbsp;working&nbsp;directory&nbsp;and&nbsp;optional&nbsp;arguments.<br /><br />&nbsp;&nbsp;Feel&nbsp;free&nbsp;to&nbsp;enhance!<br /><br />&nbsp;&nbsp;Usage:&nbsp;v1&nbsp;webserver.v1&nbsp;[docPath]&nbsp;[startURL]<br />*/<br /><br /></span><span style="color: #000000">error_reporting&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">0</span><span style="color: #0000BB;">);&nbsp;</span><span style="color: #008000">//&nbsp;1&nbsp;to&nbsp;show&nbsp;all&nbsp;warnings<br /><br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">SERVER_HOST&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">"localhost"</span><span style="color: #0000BB;">;&nbsp;</span><span style="color: #008000">//&nbsp;Host&nbsp;or&nbsp;IP&nbsp;address<br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">SERVER_PORT&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">8080</span><span style="color: #0000BB;">;&nbsp;</span><span style="color: #008000">//&nbsp;HTTP&nbsp;port<br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">SERVER_SSL_PORT&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;&nbsp;</span><span style="color: #008000">//&nbsp;443&nbsp;to&nbsp;use&nbsp;https://&nbsp;or&nbsp;0&nbsp;not&nbsp;using&nbsp;SSL<br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">CERT_DIR&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">"cert"</span><span style="color: #0000BB;">;&nbsp;</span><span style="color: #008000">//&nbsp;Directory&nbsp;of&nbsp;SSL&nbsp;certificates&nbsp;(PEM&nbsp;format)<br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">MAX_THREADS&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">10</span><span style="color: #0000BB;">;&nbsp;</span><span style="color: #008000">//&nbsp;Max.&nbsp;parallel&nbsp;requests<br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">RECV_TIMEOUT&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">30000</span><span style="color: #0000BB;">;&nbsp;</span><span style="color: #008000">//&nbsp;Milliseconds&nbsp;a&nbsp;client&nbsp;should&nbsp;send&nbsp;data<br /></span><span style="color: #0000BB;">const&nbsp;</span><span style="color: #000000">HTTP_DATE_FORMAT&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">"%D,&nbsp;%d&nbsp;%M&nbsp;%Y&nbsp;%H:%i:%s&nbsp;GMT"</span><span style="color: #0000BB;">;<br /><br />if&nbsp;(</span><span style="color: #000000">SERVER_SSL_PORT</span><span style="color: #0000BB;">!=</span><span style="color: #000000">0</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;</span><span style="color: #000000">dl&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"ssl"</span><span style="color: #0000BB;">);<br /><br /></span><span style="color: #000000">mimeTypeList&nbsp;</span><span style="color: #0000BB;">=&nbsp;array&nbsp;(<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"css"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"text/css"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"js"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"application/x-javascript"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"jpg"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"image/jpeg"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"jpeg"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"image/jpeg"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"png"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"image/png"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"gif"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"image/jpeg"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"svg"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"image/svg+xml"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"exe"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"application/octet-stream"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"pdf"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"application/pdf"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"doc"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"application/msword"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"docx"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"application/msword"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"ico"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"image/x-icon"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"mp4"&nbsp;</span><span style="color: #0000BB;">=&gt;</span><span style="color: #DD0000">"video/mp4"</span><span style="color: #0000BB;">,&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"xml"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"text/xml"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"txt"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"text/plain"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"sh"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"text/plain"</span><span style="color: #0000BB;">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"bat"&nbsp;</span><span style="color: #0000BB;">=&gt;&nbsp;</span><span style="color: #DD0000">"text/plain"<br /></span><span style="color: #0000BB;">);&nbsp;<br /><br /><br /></span><span style="color: #000000">fExitAll&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">false</span><span style="color: #0000BB;">;<br /></span><span style="color: #000000">docPath&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">getcwd&nbsp;</span><span style="color: #0000BB;">();<br />if&nbsp;(isset&nbsp;(</span><span style="color: #000000">argv</span><span style="color: #0000BB;">[</span><span style="color: #000000">2</span><span style="color: #0000BB;">]))<br />&nbsp;&nbsp;</span><span style="color: #000000">docPath&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">argv</span><span style="color: #0000BB;">[</span><span style="color: #000000">2</span><span style="color: #0000BB;">];<br /><br /></span><span style="color: #000000">realDocPath&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">realpath&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">docPath</span><span style="color: #0000BB;">);<br />print&nbsp;(</span><span style="color: #DD0000">"Document&nbsp;path&nbsp;is&nbsp;"</span><span style="color: #0000BB;">.</span><span style="color: #000000">realDocPath</span><span style="color: #0000BB;">);<br /><br /></span><span style="color: #000000">serverCertList&nbsp;</span><span style="color: #0000BB;">=&nbsp;array&nbsp;();<br /><br /><br />function&nbsp;</span><span style="color: #000000">maintenanceThread&nbsp;</span><span style="color: #0000BB;">()&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #000000">fFirstStart&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;while&nbsp;(</span><span style="color: #000000">true</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">sleep&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">500</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Do&nbsp;some&nbsp;maintenance<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(</span><span style="color: #000000">fFirstStart&nbsp;</span><span style="color: #0000BB;">&amp;&amp;&nbsp;isset&nbsp;(</span><span style="color: #000000">argv</span><span style="color: #0000BB;">[</span><span style="color: #000000">3</span><span style="color: #0000BB;">]))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Start&nbsp;Webbrowser&nbsp;URL&nbsp;(shellexec&nbsp;only&nbsp;work&nbsp;on&nbsp;Windows)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">print&nbsp;(</span><span style="color: #DD0000">"Start&nbsp;"</span><span style="color: #0000BB;">.</span><span style="color: #000000">argv</span><span style="color: #0000BB;">[</span><span style="color: #000000">3</span><span style="color: #0000BB;">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">shellexec&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">argv</span><span style="color: #0000BB;">[</span><span style="color: #000000">3</span><span style="color: #0000BB;">]);&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fFirstStart&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">false</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />}<br /><br />function&nbsp;</span><span style="color: #000000">servernameCallback&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">servername</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #000000">serverCertList</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;print&nbsp;("Callback&nbsp;".servername);<br />&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(!isset&nbsp;(</span><span style="color: #000000">serverCertList</span><span style="color: #0000BB;">[</span><span style="color: #000000">servername</span><span style="color: #0000BB;">]))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">ctx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">SSL_CTX_new&nbsp;</span><span style="color: #0000BB;">();<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">SSL_CTX_load_cert&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">CERT_DIR</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">servername</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">".crt"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">CERT_DIR</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">servername</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">".key"</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">serverCertList</span><span style="color: #0000BB;">[</span><span style="color: #000000">servername</span><span style="color: #0000BB;">]=</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">SSL_CTX_free&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;(</span><span style="color: #DD0000">"Cannot&nbsp;load&nbsp;SSL&nbsp;certificate&nbsp;"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">CERT_DIR</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">servername</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">".crt"</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">serverCertList</span><span style="color: #0000BB;">[</span><span style="color: #000000">servername</span><span style="color: #0000BB;">];<br />}<br /><br /><br />function&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(&amp;</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;&amp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">=</span><span style="color: #000000">null</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">SSL_write&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">fwrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">);<br />}<br /><br />function&nbsp;</span><span style="color: #000000">clientWriteLen&nbsp;</span><span style="color: #0000BB;">(&amp;</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;&amp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">len</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">=</span><span style="color: #000000">null</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">SSL_write&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">len</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">fwrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">len</span><span style="color: #0000BB;">);<br />}<br /><br />function&nbsp;</span><span style="color: #000000">clientReadln&nbsp;</span><span style="color: #0000BB;">(&amp;</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;&amp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">=</span><span style="color: #000000">null</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">SSL_readln&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">freadln&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">);<br />}<br /><br />function&nbsp;</span><span style="color: #000000">workerThread&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">=</span><span style="color: #000000">null</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #000000">docPath</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">realDocPath</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">mimeTypeList</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">SSL_set_fd&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">client</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #000000">SSL_accept&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;SSL&nbsp;problems<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">SSL_free&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fclose&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;</span><span style="color: #000000">lineIdx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">contentLength</span><span style="color: #0000BB;">=</span><span style="color: #000000">0</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">headerList</span><span style="color: #0000BB;">=array&nbsp;();<br /><br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Read&nbsp;the&nbsp;HTTP&nbsp;headers<br />&nbsp;&nbsp;</span><span style="color: #000000">line&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;while&nbsp;(</span><span style="color: #000000">clientReadln&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">line</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">lineIdx</span><span style="color: #0000BB;">==</span><span style="color: #000000">0</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">assign&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">method</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">uri</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">protocol</span><span style="color: #0000BB;">)&nbsp;=&nbsp;</span><span style="color: #000000">explode&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"&nbsp;"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">line</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((</span><span style="color: #000000">p</span><span style="color: #0000BB;">=</span><span style="color: #000000">strpos&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">line</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">":"</span><span style="color: #0000BB;">))!==</span><span style="color: #000000">false</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">header&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">strtoupper&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">trim&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">substr</span><span style="color: #0000BB;">(</span><span style="color: #000000">line</span><span style="color: #0000BB;">,</span><span style="color: #000000">0</span><span style="color: #0000BB;">,</span><span style="color: #000000">p</span><span style="color: #0000BB;">)));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">value&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">trim&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">substr</span><span style="color: #0000BB;">(</span><span style="color: #000000">line</span><span style="color: #0000BB;">,</span><span style="color: #000000">p</span><span style="color: #0000BB;">+</span><span style="color: #000000">1</span><span style="color: #0000BB;">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">header</span><span style="color: #0000BB;">==</span><span style="color: #DD0000">"CONTENT-LENGTH"</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">contentLength&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">value</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">headerList</span><span style="color: #0000BB;">[</span><span style="color: #000000">header</span><span style="color: #0000BB;">]=</span><span style="color: #000000">value</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(empty&nbsp;(</span><span style="color: #000000">line</span><span style="color: #0000BB;">))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">lineIdx</span><span style="color: #0000BB;">++;<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;if&nbsp;(!isset&nbsp;(</span><span style="color: #000000">uri</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;No&nbsp;URI&nbsp;given,&nbsp;close&nbsp;connection&nbsp;and&nbsp;finish&nbsp;thread<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">SSL_free&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fclose&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Parse&nbsp;URI&nbsp;and&nbsp;get&nbsp;path<br />&nbsp;&nbsp;</span><span style="color: #000000">queryString&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;</span><span style="color: #000000">p&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">strpos&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">uri</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">'?'</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">p</span><span style="color: #0000BB;">!==</span><span style="color: #000000">false</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">queryString&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">substr&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">uri</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">p</span><span style="color: #0000BB;">+</span><span style="color: #000000">1</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">strlen&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">uri</span><span style="color: #0000BB;">)-</span><span style="color: #000000">p</span><span style="color: #0000BB;">-</span><span style="color: #000000">1</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">path&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">substr&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">uri</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">p</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">path&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">uri</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #000000">path&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">url_decode&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">path</span><span style="color: #0000BB;">);<br /><br />&nbsp;&nbsp;</span><span style="color: #000000">fFound&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">false</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Check&nbsp;for&nbsp;auto&nbsp;index&nbsp;files<br />&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(!</span><span style="color: #000000">is_file&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">docPath</span><span style="color: #0000BB;">.</span><span style="color: #000000">path</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">autoIndexList&nbsp;</span><span style="color: #0000BB;">=&nbsp;array&nbsp;(</span><span style="color: #DD0000">"index.html"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"index.v1"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"index.htm"</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #000000">autoIndexList&nbsp;</span><span style="color: #0000BB;">as&nbsp;</span><span style="color: #000000">autoFile</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">path2</span><span style="color: #0000BB;">=</span><span style="color: #000000">path</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">autoFile</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">is_file&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">docPath</span><span style="color: #0000BB;">.</span><span style="color: #000000">path2</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">path&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">path</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">autoFile</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fFound&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fFound&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Handle&nbsp;the&nbsp;filename<br />&nbsp;&nbsp;</span><span style="color: #000000">filename&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">docPath</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">path</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;</span><span style="color: #000000">fileSize&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">fFound</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fileSize&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">filesize&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">filename</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Check&nbsp;if&nbsp;filename&nbsp;is&nbsp;outside&nbsp;docPath&nbsp;for&nbsp;security&nbsp;reasons<br />&nbsp;&nbsp;</span><span style="color: #000000">realFilename&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">realpath&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">filename</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">fFound&nbsp;</span><span style="color: #0000BB;">&amp;&amp;&nbsp;</span><span style="color: #000000">fileSize</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">0&nbsp;</span><span style="color: #0000BB;">&amp;&amp;&nbsp;</span><span style="color: #000000">strpos&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">realFilename</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">realDocPath</span><span style="color: #0000BB;">)!==</span><span style="color: #000000">0</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Send&nbsp;HTTP&nbsp;status&nbsp;forbidden<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"HTTP/1.1&nbsp;403&nbsp;Forbidden\r\nServer:&nbsp;V1&nbsp;HTTP-Server\r\nConnection:close\r\nContent-Type:&nbsp;text/html\r\n\r\nPath&nbsp;points&nbsp;outside&nbsp;home&nbsp;directory."</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">fFound</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Get&nbsp;MIME&nbsp;type&nbsp;from&nbsp;file&nbsp;extension<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">pi&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">pathinfo&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">filename</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fileExt&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">strtolower&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">pi</span><span style="color: #0000BB;">[</span><span style="color: #DD0000">"extension"</span><span style="color: #0000BB;">]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">mimeType&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">mimeTypeList</span><span style="color: #0000BB;">[</span><span style="color: #000000">fileExt</span><span style="color: #0000BB;">];<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(empty&nbsp;(</span><span style="color: #000000">mimeType</span><span style="color: #0000BB;">))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">mimeType&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">"text/html"</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">fileExt</span><span style="color: #0000BB;">==</span><span style="color: #DD0000">"v1"</span><span style="color: #0000BB;">)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Execute&nbsp;V1&nbsp;Script&nbsp;as&nbsp;CGI<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">output&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">retCode&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">"QUERY_STRING="</span><span style="color: #0000BB;">.</span><span style="color: #000000">queryString</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">"\0"</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">'CONTENT_TYPE='</span><span style="color: #0000BB;">.</span><span style="color: #000000">headerList</span><span style="color: #0000BB;">[</span><span style="color: #DD0000">"CONTENT-TYPE"</span><span style="color: #0000BB;">];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">"\0"</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">'SCRIPT_FILENAME='</span><span style="color: #0000BB;">.</span><span style="color: #000000">filename</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">"\0"</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">'SCRIPT_NAME='</span><span style="color: #0000BB;">.</span><span style="color: #000000">path</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">"\0"</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">'DOCUMENT_ROOT='</span><span style="color: #0000BB;">.</span><span style="color: #000000">docPath</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">"\0"</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">'REQUEST_URI='</span><span style="color: #0000BB;">.</span><span style="color: #000000">uri</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">.=</span><span style="color: #DD0000">"\0\0"</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">cmd&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">'./v1&nbsp;-w&nbsp;"'</span><span style="color: #0000BB;">.</span><span style="color: #000000">filename</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">'"'</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">exec&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">cmd</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">output</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">retCode</span><span style="color: #0000BB;">,&nbsp;(</span><span style="color: #000000">contentLength</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">0&nbsp;</span><span style="color: #0000BB;">?&nbsp;(</span><span style="color: #000000">ssl&nbsp;</span><span style="color: #0000BB;">?&nbsp;</span><span style="color: #000000">ssl&nbsp;</span><span style="color: #0000BB;">:&nbsp;</span><span style="color: #000000">client</span><span style="color: #0000BB;">)&nbsp;:&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000BB;">),&nbsp;</span><span style="color: #000000">contentLength</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">envStr</span><span style="color: #0000BB;">))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"HTTP/1.1&nbsp;200&nbsp;OK\r\nServer:&nbsp;V1&nbsp;HTTP-Server\r\n"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">output</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"HTTP/1.1&nbsp;500&nbsp;Internal&nbsp;Server&nbsp;Error\r\nServer:&nbsp;V1&nbsp;HTTP-Server\r\n\r\nCannot&nbsp;execute:&nbsp;"</span><span style="color: #0000BB;">.</span><span style="color: #000000">cmd</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Send&nbsp;file&nbsp;HTTP&nbsp;status&nbsp;200&nbsp;OK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">lastModified&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">gmdate&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">HTTP_DATE_FORMAT</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">filemtime</span><span style="color: #0000BB;">(</span><span style="color: #000000">filename</span><span style="color: #0000BB;">));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fSendFile&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">ifModSince&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">headerList</span><span style="color: #0000BB;">[</span><span style="color: #DD0000">"IF-MODIFIED-SINCE"</span><span style="color: #0000BB;">];&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset&nbsp;(</span><span style="color: #000000">ifModSince</span><span style="color: #0000BB;">))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;print&nbsp;("Check&nbsp;modification&nbsp;",ifModSince,&nbsp;"&nbsp;vs.&nbsp;",&nbsp;lastModified&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(!</span><span style="color: #000000">strcmp&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ifModSince</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">lastModified</span><span style="color: #0000BB;">))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"HTTP/1.1&nbsp;304&nbsp;Not&nbsp;Modified\r\nServer:&nbsp;V1&nbsp;HTTP-Server\r\nDate:"</span><span style="color: #0000BB;">.</span><span style="color: #000000">gmdate&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">HTTP_DATE_FORMAT</span><span style="color: #0000BB;">).</span><span style="color: #DD0000">"\r\nLast-Modified:"</span><span style="color: #0000BB;">.</span><span style="color: #000000">lastModified</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"\r\nContent-Length:"</span><span style="color: #0000BB;">.</span><span style="color: #000000">fileSize</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"\r\nContent-Type:&nbsp;"</span><span style="color: #0000BB;">.</span><span style="color: #000000">mimeType</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"\r\nConnection:close\r\n\r\n"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fSendFile&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">false</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">fSendFile</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"HTTP/1.1&nbsp;200&nbsp;OK\r\nServer:&nbsp;V1&nbsp;HTTP-Server\r\nDate:"</span><span style="color: #0000BB;">.</span><span style="color: #000000">gmdate&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">HTTP_DATE_FORMAT</span><span style="color: #0000BB;">).</span><span style="color: #DD0000">"\r\nLast-Modified:"</span><span style="color: #0000BB;">.</span><span style="color: #000000">lastModified</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"\r\nContent-Length:"</span><span style="color: #0000BB;">.</span><span style="color: #000000">fileSize</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"\r\nContent-Type:&nbsp;"</span><span style="color: #0000BB;">.</span><span style="color: #000000">mimeType</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"\r\nConnection:close\r\n\r\n"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Send&nbsp;the&nbsp;file<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fh&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">fh&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">fopen&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">filename</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"r"</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">str&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(!</span><span style="color: #000000">feof&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">len&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">fread&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWriteLen&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">str</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">len</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">fclose&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Send&nbsp;HTTP&nbsp;status&nbsp;404&nbsp;Not&nbsp;found<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">clientWrite&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"HTTP/1.1&nbsp;404&nbsp;Not&nbsp;Found\r\nServer:&nbsp;V1&nbsp;HTTP-Server\r\nConnection:close\r\nContent-Type:&nbsp;text/html\r\n\r\n"</span><span style="color: #0000BB;">.</span><span style="color: #000000">path</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"&nbsp;not&nbsp;found&nbsp;on&nbsp;this&nbsp;server."</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Close&nbsp;connection&nbsp;and&nbsp;finish&nbsp;thread<br />&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">SSL_free&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;</span><span style="color: #000000">fclose&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">client</span><span style="color: #0000BB;">);<br />}<br /><br /><br />function&nbsp;</span><span style="color: #000000">port80Thread&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #000000">fExitAll</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;</span><span style="color: #000000">currThreadIdx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;</span><span style="color: #000000">threadList&nbsp;</span><span style="color: #0000BB;">=&nbsp;array&nbsp;();<br /><br />&nbsp;&nbsp;</span><span style="color: #000000">fh2&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;while&nbsp;(!</span><span style="color: #000000">fExitAll&nbsp;</span><span style="color: #0000BB;">&amp;&amp;&nbsp;(</span><span style="color: #000000">fh2&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">fsockaccept&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">RECV_TIMEOUT</span><span style="color: #0000BB;">)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;print&nbsp;("Connection&nbsp;from&nbsp;",&nbsp;fsockip&nbsp;(fh2),&nbsp;"&nbsp;/&nbsp;",&nbsp;gethostbyaddr(fsockip&nbsp;(fh2)));&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Get&nbsp;current&nbsp;thread<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">do&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">MAX_THREADS</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">currThreadIdx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset&nbsp;(</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #000000">thread_is_active&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">thread_close&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">MAX_THREADS</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;print&nbsp;("Server&nbsp;seems&nbsp;busy.");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">sleep&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">10</span><span style="color: #0000BB;">);&nbsp;</span><span style="color: #008000">//&nbsp;Wait&nbsp;until&nbsp;thread&nbsp;is&nbsp;available<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">}<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(</span><span style="color: #000000">true</span><span style="color: #0000BB;">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Create&nbsp;new&nbsp;thread<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">t&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">thread_create&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"workerThread"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">fh2</span><span style="color: #0000BB;">);&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]=</span><span style="color: #000000">t</span><span style="color: #0000BB;">;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">thread_start&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">t</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">false</span><span style="color: #0000BB;">);&nbsp;</span><span style="color: #008000">//&nbsp;false&nbsp;=&nbsp;dont&nbsp;wait&nbsp;until&nbsp;thread&nbsp;is&nbsp;running&nbsp;<br /><br />&nbsp;&nbsp;</span><span style="color: #0000BB;">}<br />&nbsp;&nbsp;</span><span style="color: #000000">fclose&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">);<br />}<br /><br /><br />function&nbsp;</span><span style="color: #000000">port443Thread&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #000000">fExitAll</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">serverCertList</span><span style="color: #0000BB;">;<br /><br />&nbsp;&nbsp;</span><span style="color: #000000">currThreadIdx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;</span><span style="color: #000000">threadList&nbsp;</span><span style="color: #0000BB;">=&nbsp;array&nbsp;();<br /><br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Create&nbsp;SSL&nbsp;Context<br />&nbsp;&nbsp;</span><span style="color: #000000">ctx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">SSL_CTX_new&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"SSLv23_method"</span><span style="color: #0000BB;">);&nbsp;</span><span style="color: #008000">//&nbsp;TLSv1_2_server_method,&nbsp;SSLv23_method<br />&nbsp;&nbsp;//&nbsp;SSL_CTX_set_cipher_list&nbsp;(ctx,&nbsp;"HIGH:!aNULL:!kRSA:!PSK:!SRP:!MD5:!RC4");&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #0000BB;">if&nbsp;(!</span><span style="color: #000000">SSL_CTX_load_cert&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">CERT_DIR</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">".crt"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">CERT_DIR</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">".key"</span><span style="color: #0000BB;">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;(</span><span style="color: #DD0000">"Cannot&nbsp;load&nbsp;SSL&nbsp;certificate&nbsp;"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">CERT_DIR</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">"/"</span><span style="color: #0000BB;">.</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">.</span><span style="color: #DD0000">".crt"</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;(</span><span style="color: #000000">1</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #000000">serverCertList</span><span style="color: #0000BB;">[</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">]=</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;</span><span style="color: #000000">SSL_CTX_set_tlsext_servername_callback&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">"servernameCallback"</span><span style="color: #0000BB;">);<br /><br />&nbsp;&nbsp;</span><span style="color: #000000">fh2&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000BB;">;<br />&nbsp;&nbsp;while&nbsp;(!</span><span style="color: #000000">fExitAll&nbsp;</span><span style="color: #0000BB;">&amp;&amp;&nbsp;(</span><span style="color: #000000">fh2&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">fsockaccept&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">RECV_TIMEOUT</span><span style="color: #0000BB;">)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;print&nbsp;("Connection&nbsp;from&nbsp;",&nbsp;fsockip&nbsp;(fh2),&nbsp;"&nbsp;/&nbsp;",&nbsp;gethostbyaddr(fsockip&nbsp;(fh2)));&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Create&nbsp;SSL<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">ssl&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">SSL_new&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">);&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Get&nbsp;current&nbsp;thread<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">do&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">MAX_THREADS</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">currThreadIdx&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">0</span><span style="color: #0000BB;">;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset&nbsp;(</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #000000">thread_is_active&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">thread_close&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">MAX_THREADS</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;print&nbsp;("Server&nbsp;seems&nbsp;busy.");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">sleep&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">10</span><span style="color: #0000BB;">);&nbsp;</span><span style="color: #008000">//&nbsp;Wait&nbsp;until&nbsp;thread&nbsp;is&nbsp;available<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB;">}<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(</span><span style="color: #000000">true</span><span style="color: #0000BB;">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Create&nbsp;new&nbsp;thread&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">t&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">thread_create&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"workerThread"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">fh2</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">ssl</span><span style="color: #0000BB;">);&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">threadList</span><span style="color: #0000BB;">[</span><span style="color: #000000">currThreadIdx</span><span style="color: #0000BB;">]=</span><span style="color: #000000">t</span><span style="color: #0000BB;">;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">thread_start&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">t</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">false</span><span style="color: #0000BB;">);&nbsp;</span><span style="color: #008000">//&nbsp;false&nbsp;=&nbsp;dont&nbsp;wait&nbsp;until&nbsp;thread&nbsp;is&nbsp;running&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #0000BB;">}<br />&nbsp;&nbsp;</span><span style="color: #000000">SSL_CTX_free&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">ctx</span><span style="color: #0000BB;">);&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #000000">fclose&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">);<br />}<br /><br /></span><span style="color: #008000">//&nbsp;Create&nbsp;Port&nbsp;80<br /></span><span style="color: #000000">fh&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">fsockserver&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">SERVER_PORT</span><span style="color: #0000BB;">);<br />if&nbsp;(!</span><span style="color: #000000">fh</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;print&nbsp;(</span><span style="color: #DD0000">"Cannot&nbsp;create&nbsp;HTTP-Server&nbsp;on&nbsp;"</span><span style="color: #0000BB;">,&nbsp;&nbsp;</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">":"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">SERVER_PORT</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;exit&nbsp;(</span><span style="color: #000000">1</span><span style="color: #0000BB;">);<br />}<br />else&nbsp;{<br />&nbsp;&nbsp;print&nbsp;(</span><span style="color: #DD0000">"HTTP-Server&nbsp;created&nbsp;on&nbsp;"</span><span style="color: #0000BB;">,&nbsp;&nbsp;</span><span style="color: #000000">fsockip&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">),&nbsp;</span><span style="color: #DD0000">":"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">fsockport</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh</span><span style="color: #0000BB;">));<br />&nbsp;&nbsp;</span><span style="color: #000000">thread_start&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">thread_create&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"port80Thread"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">fh</span><span style="color: #0000BB;">));<br />}<br /><br />if&nbsp;(</span><span style="color: #000000">SERVER_SSL_PORT</span><span style="color: #0000BB;">&gt;</span><span style="color: #000000">0</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #008000">//&nbsp;Create&nbsp;Port&nbsp;443<br />&nbsp;&nbsp;</span><span style="color: #000000">fh2&nbsp;</span><span style="color: #0000BB;">=&nbsp;</span><span style="color: #000000">fsockserver&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">SERVER_SSL_PORT</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #000000">fh2</span><span style="color: #0000BB;">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;(</span><span style="color: #DD0000">"Cannot&nbsp;create&nbsp;HTTP-Server&nbsp;on&nbsp;"</span><span style="color: #0000BB;">,&nbsp;&nbsp;</span><span style="color: #000000">SERVER_HOST</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #DD0000">":"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">SERVER_SSL_PORT</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;(</span><span style="color: #000000">1</span><span style="color: #0000BB;">);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;(</span><span style="color: #DD0000">"HTTP-Server&nbsp;created&nbsp;on&nbsp;"</span><span style="color: #0000BB;">,&nbsp;&nbsp;</span><span style="color: #000000">fsockip&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh2</span><span style="color: #0000BB;">),&nbsp;</span><span style="color: #DD0000">":"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">fsockport</span><span style="color: #0000BB;">(</span><span style="color: #000000">fh2</span><span style="color: #0000BB;">));<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">thread_start&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">thread_create&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"port443Thread"</span><span style="color: #0000BB;">,&nbsp;</span><span style="color: #000000">fh2</span><span style="color: #0000BB;">));<br />&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #008000">//&nbsp;Maintenance&nbsp;thread<br /></span><span style="color: #000000">thread_start&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">thread_create&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #DD0000">"maintenanceThread"</span><span style="color: #0000BB;">));<br />while&nbsp;(!</span><span style="color: #000000">fExitAll</span><span style="color: #0000BB;">)<br />&nbsp;&nbsp;</span><span style="color: #000000">sleep&nbsp;</span><span style="color: #0000BB;">(</span><span style="color: #000000">1000</span><span style="color: #0000BB;">);<br /><br /></span><span style="color: #000000">?&gt;</span></code></pre>
<p><a href="index.html">back to Home</a></p>
	</div>
	<footer>
		<p>V1 Version 0.96 - Documentation generated Sun, 27 Aug 2023 15:40</p>
	</footer>
	</body>
	</html>
	
	